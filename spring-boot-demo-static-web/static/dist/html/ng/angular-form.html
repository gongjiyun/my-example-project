<!doctype html>
<html ng-app="myApp">
<head>
<script src="../js/angular-v1.3.2.js"></script>
</head>
<body>
	<div ng-controller="formController">
		<h4>Form</h4>
		<form name="signup_form" novalidateng-submit="signupForm()">
			<div class="large-12 columns">
				<label>Username</label> <input type="text"
					placeholder="Desired username" name="username"
					ng-model="signup.username" ng-minlength="3" ng-maxlength="20"
					ensure-unique="username" required />
				<div class="error"
					ng-show="signup_form.username.$dirty &&signup_form.username.$invalid">
					<small class="error" ng-show="signup_form.username.$error.required">
						Please input a username </small> <small class="error"
						ng-show="signup_form.username.$error.minlength"> Your
						username is required to be at least 3 characters </small> <small
						class="error" ng-show="signup_form.username.$error.maxlength">
						Your username cannot be longer than 20 characters </small> <small
						class="error" ng-show="signup_form.username.$error.unique">
						That username is taken, please try another </small>
				</div>
			</div>
		</form>
		<br> {{signup.username}}
	</div>
	<script type="text/javascript">
		var app = angular.module('myApp', []);
		app.controller('formController', function($scope){
			
		});
		app.directive('ensureUnique', function($http) {
			return {
				require : 'ngModel',
				link : function(scope, ele, attrs, c) {
					scope.$watch(attrs.ngModel, function(n) {
						if (!n) {
							return;
						}
						var obj = new Object();
						obj.field = attrs.ensureUnique;
						obj.value = n;						
						$http({
							method : 'POST',
							url : '/api/check/username',
							contentType: 'application/json',
							data : obj
						}).success(function(data) {
							c.$setValidity('unique', data.isUnique);
						}).error(function(data) {
							c.$setValidity('unique', false);
						});
					});
				}
			};
		});
	</script>

</body>
</html>